{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .invoice-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px 10px 0 0;
        margin-bottom: 0;
    }
    .invoice-body {
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 10px 10px;
        padding: 30px;
        background: white;
    }
    .invoice-number {
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .status-badge {
        font-size: 1.1rem;
        padding: 8px 16px;
        border-radius: 25px;
    }
    .status-pending {
        background-color: #ffc107;
        color: #000;
    }
    .status-paid {
        background-color: #28a745;
        color: white;
    }
    .status-overdue {
        background-color: #dc3545;
        color: white;
    }
    .status-cancelled {
        background-color: #6c757d;
        color: white;
    }
    .service-table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    .amount-cell {
        font-family: 'Courier New', monospace;
        text-align: right;
        font-weight: 500;
    }
    .total-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #dee2e6;
    }
    .total-row:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1.2rem;
        color: #495057;
    }
    .action-buttons .btn {
        margin: 5px;
        min-width: 140px;
    }
    .timeline-item {
        border-left: 3px solid #dee2e6;
        padding-left: 20px;
        margin-bottom: 20px;
        position: relative;
    }
    .timeline-item:before {
        content: '';
        position: absolute;
        left: -8px;
        top: 5px;
        width: 13px;
        height: 13px;
        border-radius: 50%;
        background-color: #6c757d;
    }
    .timeline-item.created:before { background-color: #007bff; }
    .timeline-item.paid:before { background-color: #28a745; }
    .timeline-item.cancelled:before { background-color: #dc3545; }
    .patient-info {
        background-color: #e9ecef;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #6c757d;
    }
    .clinic-info {
        background-color: #e7f3ff;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }
    @media print {
        .no-print { display: none !important; }
        .invoice-header { background: #f8f9fa !important; color: #000 !important; }
        .card { border: 1px solid #000 !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="no-print">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-receipt"></i> {{ title }}
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{{ url_for('receptionist.billing') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver a Facturación
                </a>
                <button onclick="window.print()" class="btn btn-outline-primary">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <!-- Cabecera de la factura -->
    <div class="invoice-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="invoice-number">
                    FACTURA #{{ invoice.invoice_number }}
                </div>
                <p class="mb-0 mt-2">
                    <i class="bi bi-calendar"></i> Fecha de emisión: {{ invoice.created_at.strftime('%d/%m/%Y') }}
                </p>
                <p class="mb-0">
                    <i class="bi bi-calendar-event"></i> Fecha de vencimiento: {{ invoice.due_date.strftime('%d/%m/%Y') }}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <span class="status-badge status-{{ invoice.status }}">
                    {% if invoice.status == 'pending' %}
                        <i class="bi bi-clock"></i> PENDIENTE
                    {% elif invoice.status == 'paid' %}
                        <i class="bi bi-check-circle"></i> PAGADA
                    {% elif invoice.status == 'overdue' %}
                        <i class="bi bi-exclamation-triangle"></i> VENCIDA
                    {% elif invoice.status == 'cancelled' %}
                        <i class="bi bi-x-circle"></i> CANCELADA
                    {% endif %}
                </span>
                {% if invoice.is_overdue() and invoice.status == 'pending' %}
                    <div class="mt-2">
                        <small class="badge bg-danger">
                            <i class="bi bi-exclamation-triangle"></i> {{ invoice.days_overdue() }} días de retraso
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="invoice-body">
        <!-- Información de la clínica y paciente -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="clinic-info">
                    <h5 class="mb-3">
                        <i class="bi bi-hospital"></i> Información de la Clínica
                    </h5>
                    <strong>Centro Médico UNTRM</strong><br>
                    Calle Los Médicos 123<br>
                    Chachapoyas, Amazonas<br>
                    <strong>RUC:</strong> 20123456789<br>
                    <strong>Teléfono:</strong> (041) 478-123<br>
                    <strong>Email:</strong> info@centromedicountrm.com
                </div>
            </div>
            <div class="col-md-6">
                <div class="patient-info">
                    <h5 class="mb-3">
                        <i class="bi bi-person"></i> Información del Paciente
                    </h5>
                    <strong>{{ invoice.patient.name }} {{ invoice.patient.lastname }}</strong><br>
                    <strong>DNI:</strong> {{ invoice.patient.dni }}<br>
                    {% if invoice.patient.email %}
                    <strong>Email:</strong> {{ invoice.patient.email }}<br>
                    {% endif %}
                    {% if invoice.patient.phone %}
                    <strong>Teléfono:</strong> {{ invoice.patient.phone }}<br>
                    {% endif %}
                    {% if invoice.patient.address %}
                    <strong>Dirección:</strong> {{ invoice.patient.address }}<br>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Detalles de servicios -->
        <div class="mb-4">
            <h5 class="mb-3">
                <i class="bi bi-list-ul"></i> Servicios y Tratamientos
            </h5>
            <div class="table-responsive">
                <table class="table service-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Descripción</th>
                            <th style="width: 15%;" class="text-center">Cantidad</th>
                            <th style="width: 20%;" class="text-end">Precio Unitario</th>
                            <th style="width: 15%;" class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in invoice.services %}
                        <tr>
                            <td>
                                <strong>{{ service.description }}</strong>
                                {% if service.notes %}
                                <br><small class="text-muted">{{ service.notes }}</small>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ service.quantity }}</td>
                            <td class="amount-cell">S/ {{ "%.2f"|format(service.unit_price) }}</td>
                            <td class="amount-cell">S/ {{ "%.2f"|format(service.get_total()) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cálculos totales -->
        <div class="row">
            <div class="col-md-6">
                {% if invoice.notes %}
                <h6><i class="bi bi-card-text"></i> Notas Adicionales</h6>
                <div class="alert alert-light">
                    {{ invoice.notes }}
                </div>
                {% endif %}
                
                {% if invoice.payment_method %}
                <h6><i class="bi bi-credit-card"></i> Método de Pago Preferido</h6>
                <p class="text-muted">
                    {% if invoice.payment_method == 'efectivo' %}
                        <i class="bi bi-cash"></i> Efectivo
                    {% elif invoice.payment_method == 'tarjeta' %}
                        <i class="bi bi-credit-card"></i> Tarjeta de Crédito/Débito
                    {% elif invoice.payment_method == 'transferencia' %}
                        <i class="bi bi-bank"></i> Transferencia Bancaria
                    {% elif invoice.payment_method == 'seguro' %}
                        <i class="bi bi-shield-check"></i> Seguro Médico
                    {% else %}
                        {{ invoice.payment_method }}
                    {% endif %}
                </p>
                {% endif %}
            </div>
            <div class="col-md-6">
                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span class="amount-cell">S/ {{ "%.2f"|format(invoice.subtotal) }}</span>
                    </div>
                    {% if invoice.discount_amount > 0 %}
                    <div class="total-row">
                        <span>Descuento ({{ "%.1f"|format(invoice.discount_percentage) }}%):</span>
                        <span class="amount-cell">- S/ {{ "%.2f"|format(invoice.discount_amount) }}</span>
                    </div>
                    {% endif %}
                    {% if invoice.tax_amount > 0 %}
                    <div class="total-row">
                        <span>Impuesto ({{ "%.1f"|format(invoice.tax_percentage) }}%):</span>
                        <span class="amount-cell">S/ {{ "%.2f"|format(invoice.tax_amount) }}</span>
                    </div>
                    {% endif %}
                    <div class="total-row">
                        <span>TOTAL:</span>
                        <span class="amount-cell">S/ {{ "%.2f"|format(invoice.total_amount) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de la factura -->
        {% if invoice.payment_date or invoice.status == 'cancelled' %}
        <div class="mt-4">
            <h6><i class="bi bi-clock-history"></i> Historial</h6>
            <div class="timeline-item created">
                <strong>Factura creada</strong><br>
                <small class="text-muted">{{ invoice.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
            </div>
            {% if invoice.payment_date %}
            <div class="timeline-item paid">
                <strong>Factura pagada</strong><br>
                <small class="text-muted">{{ invoice.payment_date.strftime('%d/%m/%Y %H:%M') }}</small>
            </div>
            {% endif %}
            {% if invoice.status == 'cancelled' %}
            <div class="timeline-item cancelled">
                <strong>Factura cancelada</strong><br>
                <small class="text-muted">{{ invoice.updated_at.strftime('%d/%m/%Y %H:%M') if invoice.updated_at else 'Fecha no disponible' }}</small>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Botones de acción -->
        <div class="no-print mt-4">
            <div class="action-buttons text-center">
                {% if invoice.status == 'pending' or invoice.status == 'overdue' %}
                    <button type="button" class="btn btn-success" 
                            onclick="markAsPaid('{{ invoice.id }}')">
                        <i class="bi bi-check-circle"></i> Marcar como Pagada
                    </button>
                    <button type="button" class="btn btn-danger" 
                            onclick="cancelInvoice('{{ invoice.id }}')">
                        <i class="bi bi-x-circle"></i> Cancelar Factura
                    </button>
                {% endif %}
                
                <button type="button" class="btn btn-primary" 
                        onclick="sendEmail('{{ invoice.id }}')">
                    <i class="bi bi-envelope"></i> Enviar por Email
                </button>
                
                <!-- Función de descarga PDF temporalmente deshabilitada -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Acción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmAction">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function markAsPaid(invoiceId) {
    $('#confirmMessage').text('¿Está seguro de que desea marcar esta factura como pagada?');
    $('#confirmAction').off('click').on('click', function() {
        $.ajax({
            url: `/receptionist/billing/${invoiceId}/pay`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error al procesar la solicitud. Intente nuevamente.');
            }
        });
        $('#confirmModal').modal('hide');
    });
    $('#confirmModal').modal('show');
}

function cancelInvoice(invoiceId) {
    $('#confirmMessage').text('¿Está seguro de que desea cancelar esta factura? Esta acción no se puede deshacer.');
    $('#confirmAction').off('click').on('click', function() {
        $.ajax({
            url: `/receptionist/billing/${invoiceId}/cancel`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error al procesar la solicitud. Intente nuevamente.');
            }
        });
        $('#confirmModal').modal('hide');
    });
    $('#confirmModal').modal('show');
}

function sendEmail(invoiceId) {
    // Esta funcionalidad se puede implementar más adelante
    alert('Funcionalidad de envío por email estará disponible próximamente.');
}

// Mostrar mensaje de éxito si existe
{% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for message in messages %}
            setTimeout(function() {
                alert('{{ message }}');
            }, 100);
        {% endfor %}
    {% endif %}
{% endwith %}
</script>
{% endblock %}
